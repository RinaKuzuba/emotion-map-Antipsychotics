<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ラッセル感情円環（VA配置）- 抗精神病薬マッピング</title>

<style>
    body { font-family: Arial, "Hiragino Sans", "Meiryo", sans-serif; background:#eef1ff; padding:20px; }
    .container { max-width:920px; margin:auto; background:#fff; padding:25px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
    
    /* 薬剤選択ボタン */
    .drug-selector {
        text-align: center;
        margin: 20px 0;
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .drug-btn {
        padding: 8px 14px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        font-size: 12px;
    }
    
    .drug-btn:hover {
        background: #f0f0ff;
        transform: translateY(-2px);
    }
    
    .drug-btn.active {
        background: #667eea;
        color: white;
    }
    
    #emotion-map {
        position:relative;
        width:700px;
        height:700px;
        margin:20px auto;
    }
    
    .circle-area {
        position:absolute;
        width:600px;
        height:600px;
        top:50px;
        left:50px;
        border-radius:50%;
        background:radial-gradient(circle,#f7f7f7 0%,#e8e8e8 60%,#ddd 100%);
        border:3px solid #999;
    }
    
    .axis-h { position:absolute; top:50%; left:10px; right:10px; height:1px; background:#aaa; }
    .axis-v { position:absolute; left:50%; top:10px; bottom:10px; width:1px; background:#aaa; }

    .axis-label {
        position:absolute; background:#fff; padding:6px 12px;
        border-radius:16px; font-weight:bold; font-size:14px;
        box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .label-top{ top:12px; left:50%; transform:translateX(-50%); }
    .label-bottom{ bottom:12px; left:50%; transform:translateX(-50%); }
    .label-left{ left:12px; top:50%; transform:translateY(-50%); }
    .label-right{ right:12px; top:50%; transform:translateY(-50%); }

    .bg-emotion{
        position:absolute;
        font-size:11px;
        color:#bbb;
        transform:translate(-50%,-50%);
        white-space:nowrap;
        opacity: 0.7;
    }
    
    /* 円内ピン（感情） */
    .symptom-pin {
        position: absolute;
        transform: translate(-50%, -100%);
        cursor: pointer;
        animation: dropIn 0.5s ease-out;
        transition: z-index 0.3s, transform 0.3s;
    }
    
    .symptom-pin:hover {
        z-index: 1000 !important;
        transform: translate(-50%, -100%) scale(1.15);
    }
    
    .symptom-pin:hover .symptom-label {
        z-index: 1001 !important;
        background: #fffae0;
        font-size: 12px;
        padding: 5px 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .pin-head {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 0 auto 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        border: 3px solid white;
        position: relative;
    }
    
    .pin-head::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 5px;
        height: 5px;
        background: rgba(255,255,255,0.7);
        border-radius: 50%;
    }
    
    .pin-stick {
        width: 2px;
        height: 15px;
        background: #333;
        margin: 0 auto;
    }
    
    .symptom-label {
        position: absolute;
        bottom: -24px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 10px;
        font-weight: bold;
        background: white;
        padding: 2px 6px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        pointer-events: none;
        transition: all 0.3s;
    }

    /* 円外ボックス（認知・行動） */
    .other-box {
        position: absolute;
        background: #f8f9fa;
        border: 2px solid;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: all 0.3s;
        animation: fadeIn 0.5s ease-out;
        max-width: 100px;
        text-align: center;
    }
    
    .other-box:hover {
        transform: scale(1.1);
        z-index: 1000;
        background: #fffae0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* 接続線 */
    .connection-line {
        position: absolute;
        height: 2px;
        background: rgba(0,0,0,0.2);
        transform-origin: left center;
        pointer-events: none;
        z-index: 1;
    }
    
    .connection-line.dashed {
        background: none;
        border-top: 2px dashed;
        opacity: 0.5;
    }

    /* 高リスク症状 */
    .highrisk-box {
        position:absolute;
        left:50%;
        bottom: 10px;
        transform:translateX(-50%);
        background:#fff5f5;
        border:2px solid #fa5252;
        color:#c92a2a;
        padding:6px 10px;
        border-radius:8px;
        font-size:11px;
        display:flex;
        align-items:flex-start;
        gap:6px;
        box-shadow:0 4px 10px rgba(0,0,0,.25);
        max-width:380px;
        text-align:left;
        z-index: 500;
    }
    .highrisk-icon{
        font-size:16px;
        line-height:1;
        margin-top:2px;
    }
    .highrisk-text strong{
        display:block;
        font-size:12px;
        margin-bottom:2px;
    }

    @keyframes dropIn {
        from {
            transform: translate(-50%, -150%) scale(0.5);
            opacity: 0;
        }
        to {
            transform: translate(-50%, -100%) scale(1);
            opacity: 1;
        }
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
        }
    }
    
    .info-box {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 12px;
        color: #555;
    }
    .legend {
        margin-top:8px;
        font-size:11px;
        color:#666;
        line-height:1.6;
    }
    .legend span{
        padding:2px 5px;
        border-radius:8px;
        margin-right:4px;
    }
    .legend .leg-emotional{
        background:#ffe8cc;
    }
    .legend .leg-other{
        background:#e7f5ff;
    }
    .legend .leg-high{
        background:#ffe3e3;
    }

    .disclaimer {
        max-width:920px;
        margin:12px auto 0;
        font-size:11px;
        color:#777;
        line-height:1.6;
    }
    .disclaimer strong{
        font-size:11px;
    }
</style>
</head>

<body>
<div class="container">
<h2>ラッセル感情円環 − 非定型抗精神病薬マッピング</h2>

<div class="info-box" style="margin-top:0; font-size:11px;">
    このアプリは、「どのような情動・状態像のときに、どの非定型抗精神病薬が処方されることが“多いか”」を
    ラッセルの Valence×Arousal モデル上にイメージとして可視化したものです。<br>
    受容体作用やエビデンスを厳密に数値化したものではなく、臨床でよく見られる典型的な状態像を
    概念的に整理した教育用ツール（オモチャ）です。
</div>

<div class="drug-selector">
    <button class="drug-btn active" onclick="showDrugTargets(event,'clear')">クリア</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'aripiprazole')">アリピプラゾール</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'olanzapine')">オランザピン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'quetiapine')">クエチアピン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'risperidone')">リスペリドン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'paliperidone')">パリペリドン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'brexpiprazole')">ブレクスピプラゾール</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'lurasidone')">ルラシドン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'blonanserin')">ブロナンセリン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'perospirone')">ペロスピロン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'asenapine')">アセナピン</button>
    <button class="drug-btn" onclick="showDrugTargets(event,'clozapine')">クロザピン</button>
</div>

<div id="emotion-map">
    <div class="circle-area">
        <div class="axis-h"></div>
        <div class="axis-v"></div>

        <div class="axis-label label-top">高覚醒（High Arousal）</div>
        <div class="axis-label label-bottom">低覚醒（Low Arousal）</div>
        <div class="axis-label label-left">不快（Unpleasant）</div>
        <div class="axis-label label-right">快（Pleasant）</div>
    </div>
</div>

<div class="info-box" id="info-box">
    薬剤を選択すると、その薬が主にアプローチする状態がマッピングされます。<br>
    <strong>ヒント：要素にマウスを重ねると詳細が見やすくなります。</strong><br>
    <div class="legend">
        <span class="leg-emotional">● 情動状態（円内）</span>
        <span class="leg-other">■ 認知・行動症状（円外・最短距離配置）</span>
        <span class="leg-high">⚠ 高リスク状態（下部・低覚醒型と高覚醒型など複数の顔つきがあり、位置は一例）</span>
    </div>
    <div style="margin-top:6px; font-size:11px; color:#888;">
        ※各位置は典型的な情動トーンのイメージであり、実際の患者さんの体験や診断を置き換えるものではありません。
    </div>
</div>
</div>

<div class="disclaimer">
    <strong>【重要な注意】</strong><br>
    ・この可視化は「どのような状態の方にこの薬剤が処方されることが多いか」をイメージとして示した概念モデルです。<br>
    ・薬理作用・診断・治療効果を定量的に保証するものではなく、臨床判断や処方の根拠として使用することはできません。<br>
    ・実際の診断・治療方針の決定は、必ず主治医などの医療専門職による個別評価に基づいて行ってください。<br>
    ・ご自身や身近な方の症状に心配がある場合は、この図で自己判断せず、医療機関・相談窓口にご相談ください。
</div>

<script>
const centerX = 300;
const centerY = 300;
const radius = 250;
const mapOffsetX = 50;
const mapOffsetY = 50;

let placedPins = [];
let placedBoxes = [];

// 背景の感情配置
const emotionsVA = [
 {ja:"覚醒した", val:10, aro:90},
 {ja:"驚いた", val:5, aro:85},
 {ja:"興奮した", val:40, aro:80},
 {ja:"大喜びの", val:80, aro:70},
 {ja:"幸せな", val:85, aro:55},
 {ja:"嬉しい", val:70, aro:45},
 {ja:"平穏な", val:55, aro:10},
 {ja:"満足した", val:65, aro:5},
 {ja:"リラックスした", val:40, aro:-25},
 {ja:"穏やかな", val:30, aro:-35},
 {ja:"眠い", val:10, aro:-70},
 {ja:"疲れた", val:-10, aro:-65},
 {ja:"陰気な", val:-50, aro:-40},
 {ja:"悲しい", val:-70, aro:-35},
 {ja:"怒った", val:-70, aro:55},
 {ja:"怖い", val:-55, aro:70},
 {ja:"心配な", val:-45, aro:40},
 {ja:"動揺した", val:-50, aro:55},
 {ja:"退屈な", val:-40, aro:-30},
 {ja:"静かな", val:35, aro:-20}
];

// 薬剤データ
const drugTargets = {
    aripiprazole: {
        name: "アリピプラゾール（エビリファイ）",
        color: "#15AABF",
        targets: [
            {name:"躁状態", val:70, aro:85, type:"emotional"},
            {name:"易刺激性", val:-60, aro:70, type:"emotional"},
            {name:"無為", val:-45, aro:-60, type:"other"},
            {name:"感情不安定", val:-20, aro:60, type:"emotional"},
            {name:"攻撃衝動", val:-70, aro:80, type:"emotional"},
            {name:"無関心", val:-40, aro:-50, type:"other"},
            {name:"思考混乱", val:-50, aro:55, type:"other"},
            {name:"焦燥感", val:-55, aro:65, type:"emotional"},
            {name:"アンヘドニア", val:-70, aro:-20, type:"emotional"},
            {name:"注意散漫", val:-35, aro:40, type:"other"}
        ]
    },
    olanzapine: {
        name: "オランザピン（ジプレキサ）",
        color: "#F08C00",
        targets: [
            {name:"激しい興奮", val:-70, aro:85, type:"emotional"},
            {name:"被害妄想", val:-75, aro:70, type:"other"},
            {name:"多弁・多動", val:15, aro:85, type:"other"},
            {name:"絶望感", val:-85, aro:-25, type:"emotional"},
            {name:"過覚醒", val:-50, aro:80, type:"emotional"},
            {name:"思考解体", val:-60, aro:60, type:"other"},
            {name:"パニック", val:-70, aro:75, type:"emotional"},
            {name:"激しい焦燥", val:-65, aro:80, type:"emotional"},
            {name:"感情枯渇", val:-60, aro:-40, type:"other"},
            {name:"強い緊張", val:-55, aro:70, type:"emotional"}
        ]
    },
    quetiapine: {
        name: "クエチアピン（セロクエル）",
        color: "#FCC419",
        targets: [
            {name:"強い不安", val:-55, aro:60, type:"emotional"},
            {name:"希死念慮", val:-90, aro:-10, type:"highrisk"},
            {name:"混合状態", val:-70, aro:60, type:"emotional"},
            {name:"過敏反応", val:-50, aro:70, type:"emotional"},
            {name:"感情爆発", val:-40, aro:80, type:"emotional"},
            {name:"夜間せん妄", val:-60, aro:70, type:"other"},
            {name:"自責感", val:-80, aro:40, type:"emotional"},
            {name:"虚無感", val:-70, aro:-30, type:"emotional"},
            {name:"心身硬直", val:-50, aro:55, type:"other"},
            {name:"焦燥不穏", val:-60, aro:70, type:"emotional"}
        ]
    },
    risperidone: {
        name: "リスペリドン（リスパダール）",
        color: "#FF6B6B",
        targets: [
            {name:"幻聴恐怖", val:-75, aro:75, type:"emotional"},
            {name:"強い猜疑心", val:-70, aro:65, type:"emotional"},
            {name:"自傷他害", val:-85, aro:80, type:"highrisk"},
            {name:"精神運動興奮", val:-45, aro:85, type:"emotional"},
            {name:"感情制御不能", val:-60, aro:75, type:"emotional"},
            {name:"思考解体不安", val:-60, aro:55, type:"other"},
            {name:"強い敵意", val:-75, aro:70, type:"emotional"},
            {name:"刺激過敏", val:-55, aro:65, type:"other"},
            {name:"妄想的緊張", val:-65, aro:50, type:"other"},
            {name:"パニック状態", val:-70, aro:80, type:"emotional"}
        ]
    },
    paliperidone: {
        name: "パリペリドン（インヴェガ）",
        color: "#4C6EF5",
        targets: [
            {name:"妄想的緊張", val:-65, aro:55, type:"other"},
            {name:"感情変動", val:-30, aro:55, type:"emotional"},
            {name:"社会的忌避", val:-55, aro:-35, type:"other"},
            {name:"感情平板化", val:-40, aro:-25, type:"other"},
            {name:"意欲喪失", val:-50, aro:-55, type:"other"},
            {name:"思考停止", val:-45, aro:-20, type:"other"},
            {name:"慢性不信", val:-60, aro:30, type:"emotional"},
            {name:"内的混乱", val:-50, aro:45, type:"other"},
            {name:"無力感", val:-55, aro:-30, type:"emotional"},
            {name:"持続過敏", val:-55, aro:60, type:"emotional"}
        ]
    },
    brexpiprazole: {
        name: "ブレクスピプラゾール（レキサルティ）",
        color: "#20C997",
        targets: [
            {name:"感情鈍麻", val:-35, aro:-25, type:"other"},
            {name:"意欲枯渇", val:-45, aro:-40, type:"other"},
            {name:"対人回避", val:-50, aro:30, type:"emotional"},
            {name:"将来不安", val:-55, aro:35, type:"emotional"},
            {name:"思考停滞", val:-35, aro:-10, type:"other"},
            {name:"虚しさ", val:-65, aro:-20, type:"emotional"},
            {name:"集中困難", val:-50, aro:10, type:"emotional"},
            {name:"感情困惑", val:-45, aro:5, type:"emotional"},
            {name:"適応不安", val:-50, aro:25, type:"emotional"},
            {name:"軽度苛立ち", val:-30, aro:35, type:"emotional"}
        ]
    },
    lurasidone: {
        name: "ルラシドン（ラツーダ）",
        color: "#12B886",
        targets: [
            {name:"深い抑うつ", val:-80, aro:-25, type:"emotional"},
            {name:"絶望感", val:-85, aro:-20, type:"emotional"},
            {name:"判断力低下", val:-55, aro:20, type:"emotional"},
            {name:"孤立感", val:-60, aro:-30, type:"emotional"},
            {name:"アンヘドニア", val:-75, aro:-20, type:"emotional"},
            {name:"無価値感", val:-80, aro:-10, type:"emotional"},
            {name:"思考停滞", val:-55, aro:5, type:"emotional"},
            {name:"悲観的恐怖", val:-70, aro:35, type:"emotional"},
            {name:"決断困難", val:-60, aro:20, type:"emotional"},
            {name:"被害的思考", val:-45, aro:25, type:"emotional"}
        ]
    },
    blonanserin: {
        name: "ブロナンセリン（ロナセン）",
        color: "#FF922B",
        targets: [
            {name:"幻覚妄想", val:-65, aro:50, type:"other"},
            {name:"意欲減退", val:-45, aro:-40, type:"other"},
            {name:"認知低下", val:-50, aro:-10, type:"other"},
            {name:"感情平板", val:-40, aro:-25, type:"other"},
            {name:"対人不安", val:-45, aro:20, type:"emotional"},
            {name:"閉塞感", val:-55, aro:-20, type:"emotional"},
            {name:"意識混濁", val:-30, aro:-35, type:"other"},
            {name:"無為状態", val:-45, aro:-50, type:"other"},
            {name:"注意欠如", val:-45, aro:25, type:"other"},
            {name:"警戒心", val:-60, aro:45, type:"emotional"}
        ]
    },
    perospirone: {
        name: "ペロスピロン（ルーラン）",
        color: "#51CF66",
        targets: [
            {name:"身体的緊張", val:-55, aro:50, type:"emotional"},
            {name:"過敏症", val:-40, aro:60, type:"emotional"},
            {name:"軽度抑うつ", val:-45, aro:-15, type:"emotional"},
            {name:"対人恐怖", val:-60, aro:40, type:"emotional"},
            {name:"反芻思考", val:-50, aro:25, type:"other"},
            {name:"軽度妄想", val:-45, aro:35, type:"other"},
            {name:"ソワソワ感", val:-45, aro:55, type:"emotional"},
            {name:"社交不安", val:-50, aro:35, type:"emotional"},
            {name:"睡眠恐怖", val:-55, aro:45, type:"emotional"},
            {name:"感情の乱れ", val:-25, aro:25, type:"emotional"}
        ]
    },
    asenapine: {
        name: "アセナピン（シクレスト）",
        color: "#9775FA",
        targets: [
            {name:"躁的興奮", val:75, aro:85, type:"emotional"},
            {name:"多弁高揚", val:65, aro:80, type:"emotional"},
            {name:"攻撃的衝動", val:-70, aro:80, type:"emotional"},
            {name:"幻聴恐怖", val:-75, aro:75, type:"emotional"},
            {name:"情緒不安定", val:-40, aro:70, type:"emotional"},
            {name:"混乱状態", val:-55, aro:70, type:"emotional"},
            {name:"破壊的衝動", val:-60, aro:85, type:"highrisk"},
            {name:"強い敵意", val:-70, aro:65, type:"emotional"},
            {name:"思考奔逸", val:-55, aro:80, type:"emotional"},
            {name:"衝動的不安", val:-60, aro:75, type:"emotional"}
        ]
    },
    clozapine: {
        name: "クロザピン（クロザリル）",
        color: "#E64980",
        targets: [
            {name:"強固な絶望", val:-90, aro:-15, type:"emotional"},
            {name:"激しい暴力", val:-85, aro:85, type:"highrisk"},
            {name:"自殺念慮", val:-95, aro:-5, type:"highrisk"},
            {name:"感情荒廃", val:-70, aro:-10, type:"emotional"},
            {name:"異常衝動", val:-55, aro:45, type:"other"},
            {name:"治療諦め", val:-70, aro:-20, type:"emotional"},
            {name:"持続焦燥", val:-65, aro:70, type:"emotional"},
            {name:"強い不信", val:-80, aro:55, type:"emotional"},
            {name:"引きこもり", val:-60, aro:-35, type:"other"},
            {name:"精神的混乱", val:-65, aro:60, type:"other"}
        ]
    }
};

// 背景感情を描画
function renderBackground(){
    const circle = document.querySelector(".circle-area");
    emotionsVA.forEach(e => {
        const px = centerX + (e.val/100)*radius;
        const py = centerY - (e.aro/100)*radius;

        const d = document.createElement("div");
        d.className = "bg-emotion";
        d.style.left = `${px}px`;
        d.style.top = `${py}px`;
        d.textContent = e.ja;
        circle.appendChild(d);
    });
}

// 円内の位置調整
function adjustPosition(x, y, minDistance = 35) {
    let adjustedX = x;
    let adjustedY = y;
    let angle = 0;
    let distance = 0;
    
    for (let attempt = 0; attempt < 8; attempt++) {
        let tooClose = false;
        
        for (let pin of placedPins) {
            const dx = adjustedX - pin.x;
            const dy = adjustedY - pin.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist < minDistance) {
                tooClose = true;
                break;
            }
        }
        
        if (!tooClose) {
            break;
        }
        
        angle += Math.PI / 4;
        distance = minDistance * 0.7;
        adjustedX = x + Math.cos(angle) * distance;
        adjustedY = y + Math.sin(angle) * distance;
    }
    
    placedPins.push({x: adjustedX, y: adjustedY});
    return {x: adjustedX, y: adjustedY};
}

// 円外ボックスの最適位置を計算
function findOptimalBoxPosition(origX, origY, boxWidth = 100, boxHeight = 30) {
    const angle = Math.atan2(origY - centerY, origX - centerX);
    const margin = 320;
    let boxX = centerX + Math.cos(angle) * margin;
    let boxY = centerY + Math.sin(angle) * margin;
    
    boxX += mapOffsetX;
    boxY += mapOffsetY;
    
    boxX -= boxWidth / 2;
    boxY -= boxHeight / 2;
    
    let attempts = 0;
    while (attempts < 8) {
        let overlap = false;
        
        for (let box of placedBoxes) {
            if (Math.abs(boxX - box.x) < boxWidth && 
                Math.abs(boxY - box.y) < boxHeight) {
                overlap = true;
                break;
            }
        }
        
        if (!overlap) {
            break;
        }
        
        const offsetAngle = angle + (attempts * 0.3);
        const offsetRadius = margin + (attempts * 15);
        boxX = centerX + Math.cos(offsetAngle) * offsetRadius + mapOffsetX - boxWidth/2;
        boxY = centerY + Math.sin(offsetAngle) * offsetRadius + mapOffsetY - boxHeight/2;
        attempts++;
    }
    
    placedBoxes.push({x: boxX, y: boxY});
    return {x: boxX, y: boxY};
}

// 円内ピンを追加
function addEmotionalPin(symptom, color, delay = 0, index = 0) {
    setTimeout(() => {
        const circle = document.querySelector(".circle-area");
        let px = centerX + (symptom.val/100)*radius;
        let py = centerY - (symptom.aro/100)*radius;
        
        const adjusted = adjustPosition(px, py);
        px = adjusted.x;
        py = adjusted.y;
        
        const pin = document.createElement("div");
        pin.className = "symptom-pin emotional";
        pin.style.left = `${px}px`;
        pin.style.top = `${py}px`;
        pin.style.zIndex = 100 + index;
        
        pin.innerHTML = `
            <div class="pin-head" style="background: ${color};"></div>
            <div class="pin-stick"></div>
            <div class="symptom-label" style="color: ${color};">${symptom.name}</div>
        `;
        
        circle.appendChild(pin);
    }, delay);
}

// 円外ボックスを追加
function addOtherBox(symptom, color, delay = 0) {
    setTimeout(() => {
        const map = document.getElementById("emotion-map");
        const origX = centerX + (symptom.val/100)*radius;
        const origY = centerY - (symptom.aro/100)*radius;
        const boxPos = findOptimalBoxPosition(origX, origY);
        
        const box = document.createElement("div");
        box.className = "other-box";
        box.style.left = `${boxPos.x}px`;
        box.style.top = `${boxPos.y}px`;
        box.style.borderColor = color;
        box.style.color = color;
        box.textContent = symptom.name;
        
        map.appendChild(box);
        
        setTimeout(() => {
            const line = document.createElement("div");
            line.className = "connection-line dashed";
            
            const boxCenterX = boxPos.x + 50 - mapOffsetX;
            const boxCenterY = boxPos.y + 15 - mapOffsetY;
            
            const dx = boxCenterX - origX;
            const dy = boxCenterY - origY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const lineAngle = Math.atan2(dy, dx);
            
            line.style.left = `${origX}px`;
            line.style.top = `${origY}px`;
            line.style.width = `${length}px`;
            line.style.transform = `rotate(${lineAngle}rad)`;
            line.style.borderColor = color;
            
            document.querySelector(".circle-area").appendChild(line);
        }, 50);
        
    }, delay);
}

// 高リスク症状
let highRiskCount = 0;
function addHighRiskSymptom(symptom, color, delay = 0) {
    setTimeout(() => {
        const map = document.getElementById("emotion-map");
        const box = document.createElement("div");
        box.className = "highrisk-box";
        box.style.bottom = `${10 + highRiskCount * 60}px`;
        highRiskCount++;

        box.innerHTML = `
            <div class="highrisk-icon">⚠</div>
            <div class="highrisk-text">
                <strong>${symptom.name}</strong>
                <span>
                    高リスク状態です。静かに沈んだ状態と、激しく興奮した状態など、
                    Valence×Arousal の 1 点では表しきれない複数のパターンがあり得ます。
                    実際の評価・対応は、必ず主治医などの医療者と相談してください。
                </span>
            </div>
        `;
        map.appendChild(box);
    }, delay);
}

// クリア
function clearPins() {
    const pins = document.querySelectorAll('.symptom-pin');
    const boxes = document.querySelectorAll('.other-box');
    const lines = document.querySelectorAll('.connection-line');
    const highrisk = document.querySelectorAll('.highrisk-box');
    
    pins.forEach(el => el.remove());
    boxes.forEach(el => el.remove());
    lines.forEach(el => el.remove());
    highrisk.forEach(el => el.remove());
    
    placedPins = [];
    placedBoxes = [];
    highRiskCount = 0;
}

// 薬剤ターゲット表示
function showDrugTargets(evt, drugKey) {
    document.querySelectorAll('.drug-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if (evt && evt.target) {
        evt.target.classList.add('active');
    }

    clearPins();
    
    const infoBox = document.getElementById('info-box');
    
    if (drugKey === 'clear') {
        infoBox.innerHTML = `
            薬剤を選択すると、その薬が主にアプローチする状態がマッピングされます。<br>
            <strong>ヒント：要素にマウスを重ねると詳細が見やすくなります。</strong><br>
            <div class="legend">
                <span class="leg-emotional">● 情動状態（円内）</span>
                <span class="leg-other">■ 認知・行動症状（円外・最短距離配置）</span>
                <span class="leg-high">⚠ 高リスク状態（下部・低覚醒型と高覚醒型など複数の顔つきがあり、位置は一例）</span>
            </div>
            <div style="margin-top:6px; font-size:11px; color:#888;">
                ※各位置は典型的な情動トーンのイメージであり、実際の患者さんの体験や診断を置き換えるものではありません。
            </div>
        `;
        return;
    }

    const drug = drugTargets[drugKey];
    if (drug) {
        infoBox.innerHTML = `
            <strong>${drug.name}</strong> が主にアプローチする状態を表示中<br>
            <strong>ヒント：要素にマウスを重ねると詳細が見やすくなります。</strong><br>
            <div class="legend">
                <span class="leg-emotional">● 情動状態（円内）</span>
                <span class="leg-other">■ 認知・行動症状（円外・最短距離配置）</span>
                <span class="leg-high">⚠ 高リスク状態（下部・低覚醒型と高覚醒型など複数の顔つきがあり、位置は一例）</span>
            </div>
            <div style="margin-top:6px; font-size:11px; color:#888;">
                ※マッピングは教育用の概念モデルであり、治療方針の決定や診断そのものを示すものではありません。<br>
                ※希死念慮・自殺念慮・激しい暴力などの高リスク状態は、静かな低覚醒型と激しく興奮した高覚醒型など、
                  1 点の座標では表しきれない多様なパターンが存在します。
            </div>
        `;
        
        let emotionalIndex = 0;
        drug.targets.forEach((symptom, index) => {
            if (symptom.type === "highrisk") {
                addHighRiskSymptom(symptom, drug.color, index * 100);
            } else if (symptom.type === "other") {
                addOtherBox(symptom, drug.color, index * 100);
            } else {
                addEmotionalPin(symptom, drug.color, index * 100, emotionalIndex++);
            }
        });
    }
}

// 初期描画
renderBackground();
</script>
</body>
</html>
